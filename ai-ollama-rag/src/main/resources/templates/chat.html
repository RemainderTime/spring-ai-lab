<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AI ËÅäÂ§©ÔºàSSE ÊµÅÂºèÔºâ</title>
    <script src="https://unpkg.com/vue@3.3.4/dist/vue.global.prod.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background:#f2f3f5; margin:0; padding:0;}
        .chat-container { max-width:800px; margin:40px auto; height:85vh; background:#fff;
            border-radius:12px; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 6px 15px rgba(0,0,0,.1);}
        .chat-header { padding:16px; font-size:20px; font-weight:bold; border-bottom:1px solid #e5e5e5; display:flex; justify-content:space-between; align-items:center;}
        .header-actions { display:flex; gap:10px; align-items:center;}
        .toggle-btn, .upload-btn { border:1px solid #0066ff; background:#fff; color:#0066ff; padding:4px 12px; border-radius:6px; cursor:pointer; font-size:14px; transition: all 0.3s;}
        .toggle-btn:hover, .upload-btn:hover { background:#e6f0ff;}
        .toggle-btn.active { background:#0066ff; color:#fff;}
        .upload-btn { display:flex; align-items:center; gap:4px;}
        .chat-body { flex:1; padding:16px; overflow-y:auto; display:flex; flex-direction:column; gap:12px; background:#f7f7f8;}
        .message { max-width:75%; padding:10px 14px; border-radius:18px; font-size:15px; white-space:pre-wrap; line-height:1.5;}
        .user { background:#0076ff; color:#fff; align-self:flex-end; border-bottom-right-radius:4px;}
        .ai { background:#f5f5f5; color:#000; align-self:flex-start; border-bottom-left-radius:4px;}
        .ai.loading::after { content:'‚ñä'; animation:blink .8s infinite; font-size:14px; margin-left:2px;}
        @keyframes blink { 0%, 49% {opacity:1;} 50%, 100% {opacity:0;} }
        .error-msg { background:#ffe6e6; color:#d00; padding:8px; border-radius:6px; font-size:13px; margin-top:8px;}
        .chat-footer { padding:16px; display:flex; gap:10px; border-top:1px solid #e5e5e5;}
        .chat-footer input, .chat-footer select { padding:8px; border-radius:6px; border:1px solid #ccc; font-size:14px;}
        .chat-footer input { flex:1;}
        .chat-footer select { min-width: 120px; cursor: pointer; background: #fff;}
        .chat-footer select:focus { outline: none; border-color: #0066ff;}

        /* Ëá™ÂÆö‰πâ RAG ‰∏ãÊãâ */
        .rag-selector-wrapper { position: relative;}
        .rag-selector { display: flex; align-items: center; gap: 6px; padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; background: #fff; cursor: pointer; font-size: 14px; min-width: 140px; transition: all 0.2s; user-select: none;}
        .rag-selector:hover { border-color: #0066ff; background: #f8f9fa;}
        .rag-selector.disabled { opacity: 0.6; cursor: not-allowed; pointer-events: none;}
        .rag-icon { font-size: 12px; opacity: 0.7;}
        .rag-label { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .rag-arrow { font-size: 10px; color: #999; transition: transform 0.2s;}
        .rag-selector:hover .rag-arrow { color: #0066ff;}
        .rag-dropdown { position: absolute; bottom: calc(100% + 4px); left: 0; min-width: 180px; background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 100; overflow: hidden;}
        .rag-dropdown-item { padding: 10px 12px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 14px; color: #333; transition: all 0.15s; position: relative;}
        .rag-dropdown-item:hover { background: #f0f7ff;}
        .rag-dropdown-item.active { background: #e6f0ff; color: #0066ff; font-weight: 500;}
        .rag-dropdown-item .check-icon { margin-left: auto; color: #0066ff; font-size: 12px;}
        .chat-footer button { padding:8px 18px; background:#0066ff; border:none; border-radius:6px; color:#fff; cursor:pointer; transition: all 0.3s;}
        .chat-footer button:hover { background:#0052cc;}
        .chat-footer button:disabled { background:#ccc; cursor:not-allowed;}

        /* ‰∏ä‰º†ÂºπÁ™ó */
        .modal-overlay { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:1000;}
        .modal-content { background:#fff; border-radius:12px; width:500px; max-width:90%; max-height:80vh; overflow:hidden; display:flex; flex-direction:column; box-shadow:0 10px 40px rgba(0,0,0,.2);}
        .modal-header { padding:20px; border-bottom:1px solid #e5e5e5; font-size:18px; font-weight:bold; display:flex; justify-content:space-between; align-items:center;}
        .close-btn { background:none; border:none; font-size:24px; color:#999; cursor:pointer; padding:0; width:30px; height:30px; display:flex; align-items:center; justify-content:center; border-radius:50%; transition: all 0.3s;}
        .close-btn:hover { background:#f0f0f0; color:#333;}
        .modal-body { padding:20px; overflow-y:auto; flex:1;}
        .form-group { margin-bottom:20px;}
        .form-group label { display:block; margin-bottom:8px; font-weight:500; font-size:14px; color:#333;}
        .form-group input, .form-group select { width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:14px; box-sizing:border-box;}
        .form-group input:focus, .form-group select:focus { outline:none; border-color:#0066ff;}
        .tag-input-wrapper { position: relative; }
        .tag-dropdown { position: absolute; top: calc(100% + 4px); left: 0; min-width: 180px; max-width: 300px; background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; max-height: 240px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.15);}
        .tag-dropdown-item { padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.15s; font-size: 14px; color: #333;}
        .tag-dropdown-item:first-child { border-radius: 8px 8px 0 0;}
        .tag-dropdown-item:last-child { border-radius: 0 0 8px 8px;}
        .tag-dropdown-item:hover, .tag-dropdown-item.active { background: #f0f7ff;}
        .tag-dropdown-item.active { background: #e6f0ff;}
        .tag-icon { font-size: 12px; opacity: 0.6;}
        .tag-hint { font-size: 11px; color: #666; margin-top: 4px; padding: 4px 8px; background: #f8f9fa; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px; border-left: 2px solid #0066ff;}
        .tag-hint.existing { background: #f0f9f0; border-left-color: #28a745; color: #155724;}
        .tag-hint strong { font-weight: 500;}
        .hint-icon { font-size: 12px;}
        .tag-selector { display:flex; gap:10px;}
        .tag-selector input { flex:1;}
        .tag-selector button { padding:10px 16px; background:#f5f5f5; border:1px solid #ccc; border-radius:6px; cursor:pointer; white-space:nowrap; transition: all 0.3s;}
        .tag-selector button:hover { background:#e5e5e5;}
        .tag-selector button.active { background:#0066ff; color:#fff; border-color:#0066ff;}
        .file-upload-area { border:2px dashed #ccc; border-radius:8px; padding:30px; text-align:center; cursor:pointer; transition: all 0.3s; background:#fafafa;}
        .file-upload-area:hover { border-color:#0066ff; background:#f0f7ff;}
        .file-upload-area.dragging { border-color:#0066ff; background:#e6f0ff;}
        .file-list { margin-top:15px; max-height:200px; overflow-y:auto;}
        .file-item { display:flex; align-items:center; justify-content:space-between; padding:8px 12px; background:#f5f5f5; border-radius:6px; margin-bottom:8px; font-size:14px;}
        .file-item button { background:#ff4444; color:#fff; border:none; padding:4px 10px; border-radius:4px; cursor:pointer; font-size:12px; transition: all 0.3s;}
        .file-item button:hover { background:#cc0000;}
        .modal-footer { padding:20px; border-top:1px solid #e5e5e5; display:flex; gap:10px; justify-content:flex-end;}
        .modal-footer button { padding:10px 20px; border-radius:6px; cursor:pointer; font-size:14px; border:none; transition: all 0.3s;}
        .btn-cancel { background:#f5f5f5; color:#333;}
        .btn-cancel:hover { background:#e5e5e5;}
        .btn-submit { background:#0066ff; color:#fff;}
        .btn-submit:hover { background:#0052cc;}
        .btn-submit:disabled { background:#ccc; cursor:not-allowed;}
        .upload-success { background:#e6ffe6; color:#006600; padding:12px; border-radius:6px; margin-bottom:15px; font-size:14px;}
    </style>
</head>
<body>

<div id="app" class="chat-container">
    <div class="chat-header">
        AI Âä©Êâã
        <div class="header-actions">
            <button class="upload-btn" @click="showUploadModal = true">
                <span>üìÅ</span> ‰∏ä‰º†Áü•ËØÜÂ∫ì
            </button>
            <button class="toggle-btn" :class="{active: useRag}" @click="useRag = !useRag">
                {{ useRag ? 'Â∏¶ RAG' : '‰∏çÂ∏¶ RAG' }}
            </button>
        </div>
    </div>

    <div class="chat-body" ref="chatBody">
        <div v-for="(msg, idx) in chatHistory" :key="idx" :class="['message', msg.role, {loading: msg.loading}]">
            <template v-if="msg.role === 'ai'">
                <span class="ai-content"></span>
            </template>
            <template v-else>{{ msg.content }}</template>
            <div v-if="msg.error" class="error-msg">{{ msg.error }}</div>
        </div>
    </div>

    <div class="chat-footer">
        <select v-model="selectedModel" :disabled="isLoading">
            <option v-for="model in models" :value="model">{{ model }}</option>
        </select>

        <!-- Ëá™ÂÆö‰πâ RAG Ê†áÁ≠æ‰∏ãÊãâ -->
        <div v-if="useRag" class="rag-selector-wrapper">
            <div class="rag-selector" @click="toggleRagDropdown" :class="{disabled: isLoading}">
                <span class="rag-icon">üè∑Ô∏è</span>
                <span class="rag-label">{{ selectedRagTag }}</span>
                <span class="rag-arrow">‚ñº</span>
            </div>
            <div v-if="showRagDropdown" class="rag-dropdown" @click.stop>
                <div
                        v-for="(tag, idx) in ragTags"
                        :key="tag"
                        :class="['rag-dropdown-item', {active: selectedRagTag === tag}]"
                        @click="selectRagTag(tag)">
                    <span class="tag-icon">üè∑Ô∏è</span>
                    {{ tag }}
                    <span v-if="selectedRagTag === tag" class="check-icon">‚úì</span>
                </div>
            </div>
        </div>

        <input type="text" placeholder="ËæìÂÖ•Ê∂àÊÅØ‚Ä¶" v-model="message" @keyup.enter="sendMessage" :disabled="isLoading">
        <button @click="sendMessage" :disabled="isLoading">{{ isLoading ? 'ÂèëÈÄÅ‰∏≠...' : 'ÂèëÈÄÅ' }}</button>
    </div>

    <!-- ‰∏ä‰º†ÂºπÁ™ó -->
    <div v-if="showUploadModal" class="modal-overlay" @click.self="closeUploadModal">
        <div class="modal-content">
            <div class="modal-header">
                ‰∏ä‰º†Áü•ËØÜÂ∫ìÊñá‰ª∂
                <button class="close-btn" @click="closeUploadModal">√ó</button>
            </div>
            <div class="modal-body">
                <div v-if="uploadSuccess" class="upload-success">
                    ‚úì {{ uploadSuccess }}
                </div>

                <div class="form-group">
                    <label>ÈÄâÊã©ÊàñÊñ∞Â¢ûÊ†áÁ≠æ</label>
                    <div class="tag-input-wrapper">
                        <input
                                ref="tagInput"
                                v-model="tagInputValue"
                                type="text"
                                placeholder="ËæìÂÖ•Ê†áÁ≠æÂêçÁß∞..."
                                @input="handleTagInput"
                                @keydown.enter.prevent="handleTagEnter"
                                @keydown.down.prevent="navigateDropdown(1)"
                                @keydown.up.prevent="navigateDropdown(-1)"
                                @keydown.escape="showTagDropdown = false"
                                @focus="handleTagFocus"
                                @blur="handleTagBlur"
                                autocomplete="off">

                        <!-- ‰∏ãÊãâÂàóË°® -->
                        <div v-if="showTagDropdown && filteredTags.length > 0" class="tag-dropdown">
                            <div
                                    v-for="(tag, idx) in filteredTags"
                                    :key="tag"
                                    :class="['tag-dropdown-item', {active: selectedDropdownIndex === idx}]"
                                    @mousedown.prevent="selectTag(tag)"
                                    @mouseenter="selectedDropdownIndex = idx">
                                <span class="tag-icon">üè∑Ô∏è</span>
                                {{ tag }}
                            </div>
                        </div>

                        <!-- ÊèêÁ§∫‰ø°ÊÅØ -->
                        <div v-if="tagInputValue && !isExistingTag && !showTagDropdown" class="tag-hint">
                            <span class="hint-icon">‚ú®</span>
                            Êåâ Enter ÂàõÂª∫ <strong>{{ tagInputValue }}</strong>
                        </div>
                        <div v-else-if="tagInputValue && isExistingTag && !showTagDropdown" class="tag-hint existing">
                            <span class="hint-icon">‚úì</span>
                            Â∑≤ÊúâÊ†áÁ≠æ <strong>{{ tagInputValue }}</strong>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>‰∏ä‰º†Êñá‰ª∂ÔºàÂçï‰∏™Êñá‰ª∂ÊúÄÂ§ß 10MBÔºâ</label>
                    <div
                            class="file-upload-area"
                            :class="{dragging: isDragging}"
                            @click="$refs.fileInput.click()"
                            @dragover.prevent="isDragging = true"
                            @dragleave.prevent="isDragging = false"
                            @drop.prevent="handleDrop">
                        <div>üìÑ ÁÇπÂáªÊàñÊãñÊãΩÊñá‰ª∂Âà∞ËøôÈáå</div>
                        <div style="font-size:12px; color:#999; margin-top:8px;">ÊîØÊåÅ PDF, TXT, DOCX Á≠âÊ†ºÂºèÔºåÂçï‰∏™Êñá‰ª∂ ‚â§ 10MB</div>
                    </div>
                    <input
                            type="file"
                            ref="fileInput"
                            multiple
                            style="display:none"
                            @change="handleFileSelect"
                            accept=".pdf,.txt,.doc,.docx,.md">
                </div>

                <div v-if="uploadFiles.length > 0" class="file-list">
                    <div v-for="(file, idx) in uploadFiles" :key="idx" class="file-item">
                        <span>{{ file.name }} ({{ formatFileSize(file.size) }})</span>
                        <button @click="removeFile(idx)">Âà†Èô§</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" @click="closeUploadModal">ÂèñÊ∂à</button>
                <button
                        class="btn-submit"
                        @click="submitUpload"
                        :disabled="isUploading || !canUpload">
                    {{ isUploading ? '‰∏ä‰º†‰∏≠...' : '‰∏ä‰º†' }}
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, nextTick } = Vue;

    createApp({
        data() {
            return {
                message: '',
                selectedModel: 'deepseek-r1:1.5b',
                selectedRagTag: '',  // ÂàùÂßã‰∏∫Á©∫ÔºåÁî± loadRagTags ËÆæÁΩÆ
                useRag: false,
                isLoading: false,
                models: ['deepseek-r1:1.5b', 'deepseek-r2:3b', 'mistral'],
                ragTags: ['rag', 'finance', 'legal'],
                chatHistory: [],

                // ‰∏ä‰º†Áõ∏ÂÖ≥
                showUploadModal: false,
                tagInputValue: '',
                showTagDropdown: false,
                selectedDropdownIndex: -1,
                uploadFiles: [],
                isDragging: false,
                isUploading: false,
                uploadSuccess: '',

                // RAG ‰∏ãÊãâ
                showRagDropdown: false
            };
        },
        computed: {
            canUpload() {
                return this.tagInputValue.trim() && this.uploadFiles.length > 0;
            },
            filteredTags() {
                if (!this.tagInputValue) {
                    return this.ragTags;
                }
                const input = this.tagInputValue.toLowerCase();
                return this.ragTags.filter(tag => tag.toLowerCase().includes(input));
            },
            isExistingTag() {
                return this.ragTags.some(tag =>
                    tag.toLowerCase() === this.tagInputValue.toLowerCase()
                );
            }
        },
        mounted() {
            this.loadRagTags();

            // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠‰∏ãÊãâ
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.rag-selector-wrapper')) {
                    this.showRagDropdown = false;
                }
            });
        },
        methods: {
            async loadRagTags() {
                try {
                    const response = await fetch('http://localhost:10001/ai/ollama/rag/query_rag_tag_list');
                    if (response.ok) {
                        const tags = await response.json();
                        if (tags && tags.length > 0) {
                            this.ragTags = tags;
                            // ÈªòËÆ§ÈÄâÊã©Á¨¨‰∏Ä‰∏™Ê†áÁ≠æ
                            if (!this.selectedRagTag || !tags.includes(this.selectedRagTag)) {
                                this.selectedRagTag = tags[0];
                            }
                        }
                    }
                } catch (error) {
                    console.error('Âä†ËΩΩÊ†áÁ≠æÂàóË°®Â§±Ë¥•:', error);
                }
            },

            async sendMessage() {
                if (!this.message.trim() || this.isLoading) return;

                this.chatHistory.push({ role: 'user', content: this.message });
                await nextTick();
                this.scrollBottom();

                const aiMessage = {
                    role: 'ai',
                    content: '',
                    loading: true,
                    error: null
                };
                this.chatHistory.push(aiMessage);

                const msg = this.message;
                this.message = '';
                this.isLoading = true;

                await nextTick();
                const aiElement = this.$refs.chatBody.querySelector('.message.ai:last-child .ai-content');

                const api = this.useRag ?
                    `http://localhost:10001/ai/ollama/generate_stream_rag` :
                    `http://localhost:10001/ai/ollama/generate_stream`;

                const params = new URLSearchParams({ model: this.selectedModel, message: msg });
                if (this.useRag) params.append('ragTag', this.selectedRagTag);

                const evtSource = new EventSource(`${api}?${params.toString()}&t=${Date.now()}`);

                evtSource.onmessage = (event) => {
                    if (!event.data) return;

                    if (event.data === "[DONE]") {
                        evtSource.close();
                        aiMessage.loading = false;
                        this.isLoading = false;
                        return;
                    }

                    aiMessage.content += event.data;
                    if (aiElement) {
                        aiElement.textContent += event.data;
                        this.scrollBottom();
                    }
                };

                evtSource.onerror = (err) => {
                    console.error("SSE ËøûÊé•ÂºÇÂ∏∏", err);
                    evtSource.close();
                    aiMessage.loading = false;
                    this.isLoading = false;

                    if (!aiMessage.content) {
                        aiMessage.error = "ËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÂêéÁ´ØÊúçÂä°ÊàñÁΩëÁªú";
                    }
                };
            },

            scrollBottom() {
                const body = this.$refs.chatBody;
                if (body) {
                    body.scrollTop = body.scrollHeight;
                }
            },

            // RAG ‰∏ãÊãâÁõ∏ÂÖ≥
            toggleRagDropdown() {
                if (!this.isLoading) {
                    this.showRagDropdown = !this.showRagDropdown;
                }
            },

            selectRagTag(tag) {
                this.selectedRagTag = tag;
                this.showRagDropdown = false;
            },

            // ‰∏ä‰º†Áõ∏ÂÖ≥ÊñπÊ≥ï
            handleTagInput() {
                this.showTagDropdown = true;
                this.uploadSuccess = '';

                // Ëá™Âä®ÈÄâÊã©Á¨¨‰∏Ä‰∏™ÂåπÈÖçÈ°π
                this.$nextTick(() => {
                    if (this.filteredTags.length > 0) {
                        this.selectedDropdownIndex = 0;
                    } else {
                        this.selectedDropdownIndex = -1;
                    }
                });
            },

            handleTagFocus() {
                if (this.ragTags.length > 0) {
                    this.showTagDropdown = true;
                    // Â¶ÇÊûúÊúâËæìÂÖ•ÂÜÖÂÆπÔºåËá™Âä®ÈÄâÊã©Á¨¨‰∏Ä‰∏™
                    if (this.tagInputValue && this.filteredTags.length > 0) {
                        this.selectedDropdownIndex = 0;
                    } else {
                        this.selectedDropdownIndex = -1;
                    }
                }
            },

            handleTagEnter() {
                if (this.selectedDropdownIndex >= 0 && this.filteredTags.length > 0) {
                    // ÈÄâÊã©‰∏ãÊãâÂàóË°®‰∏≠ÁöÑÊ†áÁ≠æ
                    this.selectTag(this.filteredTags[this.selectedDropdownIndex]);
                } else if (this.tagInputValue.trim()) {
                    // ‰ΩøÁî®ÂΩìÂâçËæìÂÖ•ÁöÑÊ†áÁ≠æÔºàÂèØËÉΩÊòØÊñ∞Ê†áÁ≠æÔºâ
                    this.showTagDropdown = false;
                }
            },

            navigateDropdown(direction) {
                if (this.filteredTags.length === 0) return;

                this.selectedDropdownIndex += direction;

                if (this.selectedDropdownIndex < 0) {
                    this.selectedDropdownIndex = this.filteredTags.length - 1;
                } else if (this.selectedDropdownIndex >= this.filteredTags.length) {
                    this.selectedDropdownIndex = 0;
                }

                // ÊªöÂä®Âà∞ÈÄâ‰∏≠È°π
                this.$nextTick(() => {
                    const dropdown = document.querySelector('.tag-dropdown');
                    const activeItem = document.querySelector('.tag-dropdown-item.active');
                    if (dropdown && activeItem) {
                        const dropdownRect = dropdown.getBoundingClientRect();
                        const activeRect = activeItem.getBoundingClientRect();

                        if (activeRect.bottom > dropdownRect.bottom) {
                            activeItem.scrollIntoView({ block: 'end', behavior: 'smooth' });
                        } else if (activeRect.top < dropdownRect.top) {
                            activeItem.scrollIntoView({ block: 'start', behavior: 'smooth' });
                        }
                    }
                });
            },

            selectTag(tag) {
                this.tagInputValue = tag;
                this.showTagDropdown = false;
                this.selectedDropdownIndex = -1;
                // ÈÄâÊã©ÂêéËÅöÁÑ¶Âà∞Êñá‰ª∂‰∏ä‰º†Âå∫Âüü
                this.$nextTick(() => {
                    const fileArea = document.querySelector('.file-upload-area');
                    if (fileArea) {
                        fileArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                });
            },

            handleTagBlur() {
                // Âª∂ËøüÂÖ≥Èó≠Ôºå‰ª•‰æøÁÇπÂáª‰∫ã‰ª∂ËÉΩËß¶Âèë
                setTimeout(() => {
                    this.showTagDropdown = false;
                    this.selectedDropdownIndex = -1;
                }, 200);
            },

            handleFileSelect(event) {
                const files = Array.from(event.target.files);
                this.addFiles(files);
            },

            handleDrop(event) {
                this.isDragging = false;
                const files = Array.from(event.dataTransfer.files);
                this.addFiles(files);
            },

            addFiles(files) {
                const maxSize = 10 * 1024 * 1024; // 100MB
                const oversizedFiles = [];
                const validFiles = [];

                files.forEach(file => {
                    if (file.size > maxSize) {
                        oversizedFiles.push(file.name);
                    } else {
                        validFiles.push(file);
                    }
                });

                if (oversizedFiles.length > 0) {
                    alert(`‰ª•‰∏ãÊñá‰ª∂Ë∂ÖËøá 10MB ÈôêÂà∂ÔºåÂ∑≤Ë¢´ÂøΩÁï•Ôºö\n${oversizedFiles.join('\n')}`);
                }

                this.uploadFiles.push(...validFiles);
                this.uploadSuccess = '';
            },

            removeFile(index) {
                this.uploadFiles.splice(index, 1);
            },

            formatFileSize(bytes) {
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            },

            async submitUpload() {
                if (!this.canUpload || this.isUploading) return;

                const ragTag = this.tagInputValue.trim();

                // ËÆ°ÁÆóÊÄªÂ§ßÂ∞è
                const totalSize = this.uploadFiles.reduce((sum, file) => sum + file.size, 0);
                const maxTotalSize = 50 * 1024 * 1024; // 50MB

                if (totalSize > maxTotalSize) {
                    alert(`Êñá‰ª∂ÊÄªÂ§ßÂ∞èË∂ÖËøá 50MB ÈôêÂà∂ÔºàÂΩìÂâç: ${this.formatFileSize(totalSize)}ÔºâÔºåËØ∑ÂàÜÊâπ‰∏ä‰º†`);
                    return;
                }

                const formData = new FormData();
                formData.append('ragTag', ragTag);
                this.uploadFiles.forEach(file => {
                    formData.append('file', file);
                });

                this.isUploading = true;
                this.uploadSuccess = '';

                try {
                    const response = await fetch('http://localhost:10001/ai/ollama/rag/file/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.text();
                        this.uploadSuccess = `‰∏ä‰º†ÊàêÂäüÔºÅÂ∑≤Ê∑ªÂä†Âà∞Ê†áÁ≠æ: ${ragTag}`;

                        // Âà∑Êñ∞Ê†áÁ≠æÂàóË°®
                        await this.loadRagTags();

                        // Ê∏ÖÁ©∫Êñá‰ª∂ÂàóË°®
                        this.uploadFiles = [];
                        this.$refs.fileInput.value = '';

                        // Ê∏ÖÁ©∫Ê†áÁ≠æËæìÂÖ•
                        this.tagInputValue = '';

                        // 3ÁßíÂêéËá™Âä®ÂÖ≥Èó≠ÂºπÁ™ó
                        setTimeout(() => {
                            if (this.uploadSuccess) {
                                this.closeUploadModal();
                            }
                        }, 3000);
                    } else {
                        const errorText = await response.text();
                        if (errorText.includes('Maximum upload size exceeded') || errorText.includes('MaxUploadSizeExceededException')) {
                            alert('Êñá‰ª∂Â§ßÂ∞èË∂ÖËøáÈôêÂà∂ÔºÅËØ∑Ê£ÄÊü•Ôºö\n1. Âçï‰∏™Êñá‰ª∂‰∏çË∂ÖËøá 10MB\n2. ÊÄªÂ§ßÂ∞è‰∏çË∂ÖËøá 50MB');
                        } else {
                            alert('‰∏ä‰º†Â§±Ë¥•: ' + errorText);
                        }
                    }
                } catch (error) {
                    console.error('‰∏ä‰º†ÈîôËØØ:', error);
                    alert('‰∏ä‰º†Â§±Ë¥•: ' + error.message);
                } finally {
                    this.isUploading = false;
                }
            },

            closeUploadModal() {
                this.showUploadModal = false;
                this.tagInputValue = '';
                this.showTagDropdown = false;
                this.selectedDropdownIndex = -1;
                this.uploadFiles = [];
                this.uploadSuccess = '';
                if (this.$refs.fileInput) {
                    this.$refs.fileInput.value = '';
                }
            }
        }
    }).mount("#app");
</script>

</body>
</html>